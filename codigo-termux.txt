#!/data/data/com.termux/files/usr/bin/bash

export GIT_DISCOVERY_ACROSS_FILESYSTEM=1

echo "[INFO] Instalando depend칡ncias..."
pkg update -y && pkg upgrade -y
pkg install git gh python rsync -y
pip install --upgrade git-filter-repo >/dev/null 2>&1 || echo "[INFO] git-filter-repo j치 instalado ou falhou"

echo "[INFO] Verificando login no GitHub..."
if ! gh auth status >/dev/null 2>&1; then
  gh auth login
else
  echo "[INFO] J치 autenticado no GitHub."
fi

WORKDIR="$HOME/GITHUB"
SDCARD_DIR="/sdcard/GITHUB"

# Copia arquivos do SDCard se existir
if [ -d "$SDCARD_DIR" ]; then
    echo "[INFO] Copiando arquivos do SDCard para $WORKDIR..."
    mkdir -p "$WORKDIR"
    rsync -a --progress "$SDCARD_DIR/" "$WORKDIR/"
fi

cd "$WORKDIR" || { echo "[ERRO] Falha ao acessar $WORKDIR"; exit 1; }

# Inicializa Git se necess치rio
if [ ! -d ".git" ]; then
    echo "[INFO] Inicializando reposit칩rio Git..."
    git init || { echo "[ERRO] Falha ao inicializar Git"; exit 1; }
fi

# Configura Git global
git config --global --add safe.directory "$WORKDIR"
git config --global user.name "Seu Nome"
git config --global user.email "seuemail@example.com"
git config --global core.compression 0
git config --global pack.threads 4

# =====================================================
# Remove arquivos grandes (>25MB)
# =====================================================
echo "[INFO] Removendo arquivos grandes (>25MB)..."
find . -type f -size +25M -exec rm -f {} \;
echo "[INFO] Remo칞칚o de arquivos grandes conclu칤da."

# =====================================================
# Limpa hist칩rico se git-filter-repo dispon칤vel
# =====================================================
if command -v git-filter-repo >/dev/null 2>&1; then
    echo "[INFO] Limpando hist칩rico de arquivos grandes (>25MB)..."
    git filter-repo --strip-blobs-bigger-than 25M >/dev/null 2>&1 || echo "[INFO] Nenhum arquivo grande encontrado no hist칩rico"
fi

# =====================================================
# Seleciona reposit칩rio remoto
# =====================================================
echo ""
echo "[INFO] Seus reposit칩rios no GitHub:"
gh repo list --limit 20
echo ""
read -p "游녤 Digite o nome completo do reposit칩rio (usuario/repositorio): " REPO

if [[ ! "$REPO" =~ .+/.+ ]]; then
    echo "[ERRO] O reposit칩rio precisa estar no formato usuario/repositorio"
    exit 1
fi

if ! gh repo view "$REPO" >/dev/null 2>&1; then
    echo "[INFO] Reposit칩rio n칚o encontrado. Criando..."
    gh repo create "$REPO" --public
fi

git remote remove origin 2>/dev/null
git remote add origin "https://github.com/$REPO.git"

# =====================================================
# Commit inicial ou incremental
# =====================================================
echo "[INFO] Adicionando altera칞칫es locais..."
git add -A

# Se diret칩rio vazio, cria arquivo dummy
if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
    if [ -z "$(ls -A)" ]; then
        echo "[INFO] Diret칩rio vazio, criando arquivo README.md..."
        echo "# Inicializa칞칚o do reposit칩rio" > README.md
        git add README.md
    fi
    echo "[INFO] Criando commit inicial..."
    git commit -m "Commit inicial via Termux"
else
    if git diff-index --quiet HEAD --; then
        echo "[INFO] Nenhuma mudan칞a local a commitar"
    else
        git commit -m "Commit incremental via Termux"
    fi
fi

# Garante branch main
git branch -M main

# =====================================================
# Push final otimizado
# =====================================================
echo "[INFO] Push final otimizado..."
git -c core.compression=0 -c pack.threads=4 push -u origin main --force

if [ $? -eq 0 ]; then
    echo "[OK] Upload conclu칤do com sucesso no GitHub!"
else
    echo "[ERRO] Falha ao enviar. Pode haver arquivos grandes antigos no hist칩rico."
fi